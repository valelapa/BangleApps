!function(){"use strict";const t={STOP:63488,PAUSE:65504,RUN:2016};function e(t,e,n){g.setColor(0),g.fillRect(e-60,n,e+60,n+30),g.setColor(65535),g.drawString(t,e,n)}function n(n){var r;g.setFontVector(30),g.setFontAlign(0,-1,0),e((n.distance/1e3).toFixed(2),60,55),e(function(t){const e=Math.round(t),n=Math.floor(e/3600),r=Math.floor(e/60)%60,a=e%60;return(n?n+":":"")+("0"+r).substr(-2)+":"+("0"+a).substr(-2)}(n.duration),180,55),e(function(t){if(t<.1667)return"__'__\"";const e=Math.round(1e3/t),n=Math.floor(e/60),r=e%60;return("0"+n).substr(-2)+"'"+("0"+r).substr(-2)+'"'}(n.speed),60,115),e(n.hr.toFixed(0),180,115),e(n.steps.toFixed(0),60,175),e(n.cadence.toFixed(0),180,175),g.setFont("6x8",2),g.setColor(n.gpsValid?2016:63488),g.fillRect(0,216,80,240),g.setColor(0),g.drawString("GPS",40,220),g.setColor(65535),g.fillRect(80,216,160,240),g.setColor(0),g.drawString(("0"+(r=new Date).getHours()).substr(-2)+":"+("0"+r.getMinutes()).substr(-2),120,220),g.setColor(t[n.status]),g.fillRect(160,216,240,240),g.setColor(0),g.drawString(n.status,200,220)}function r(t){g.clear(),g.setColor(50712),g.setFont("6x8",2),g.setFontAlign(0,-1,0),g.drawString("DIST (KM)",60,32),g.drawString("TIME",180,32),g.drawString("PACE",60,92),g.drawString("HEART",180,92),g.drawString("STEPS",60,152),g.drawString("CADENCE",180,152),n(t),Bangle.drawWidgets()}function a(t){NRF.updateServices({"f8b20001-89ad-4220-8c9f-d81756009f0c":{"f8b20002-89ad-4220-8c9f-d81756009f0c":{descriptio:"duration",notify:!0,readable:!0,value:[t.duration]},"f8b20003-89ad-4220-8c9f-d81756009f0c":{description:"distance",notify:"true",readable:"true",value:[t.distance]},"f8b20004-89ad-4220-8c9f-d81756009f0c":{description:"speed",notify:"true",readable:"true",value:[t.speed]},"f8b20005-89ad-4220-8c9f-d81756009f0c":{description:"steps",notify:"true",readable:"true",value:[t.steps]},"f8b20006-89ad-4220-8c9f-d81756009f0c":{description:"cadence",notify:"true",readable:"true",value:[t.cadence]}},"f8b20007-89ad-4220-8c9f-d81756009f0c":{"f8b20008-89ad-4220-8c9f-d81756009f0c":{description:"HR",readable:!0,notify:!0,value:[t.hr]}}})}function o(t){t.file.write([Date.now().toFixed(0),t.lat.toFixed(6),t.lon.toFixed(6),t.alt.toFixed(2),t.duration.toFixed(0),t.distance.toFixed(2),t.cadence.toFixed(0),t.hr.toFixed(0),t.steps.toFixed(0)].join(",")+"\n"),a(t)}var d;function i(t){t.status===d.Stopped&&function(t){const e=(new Date).toISOString().replace(/[-:]/g,""),n=`banglerun_${e.substr(2,6)}_${e.substr(9,6)}`;t.file=require("Storage").open(n,"w"),t.file.write(["timestamp","latitude","longitude","altitude","duration","distance","heartrate","cadence","steps"].join(",")+"\n")}(t),t.status===d.Running?t.status=d.Paused:t.status=d.Running,n(t)}!function(t){t.Stopped="STOP",t.Paused="PAUSE",t.Running="RUN"}(d||(d={}));const s={fix:NaN,lat:NaN,lon:NaN,alt:NaN,vel:NaN,dop:NaN,gpsValid:!1,x:NaN,y:NaN,z:NaN,v:NaN,t:NaN,dt:NaN,pError:NaN,vError:NaN,hr:60,hrError:100,file:null,drawing:!1,status:d.Stopped,duration:0,distance:0,speed:0,steps:0,cadence:0};var c;c=s,Bangle.on("GPS",t=>function(t,e){t.lat=e.lat,t.lon=e.lon,t.alt=e.alt,t.vel=e.speed/3.6,t.fix=e.fix,t.dop=e.hdop,t.gpsValid=t.fix>0&&t.dop<=5,function(t){const e=Date.now();let n=(e-t.t)/1e3;if(isFinite(n)||(n=0),t.t=e,t.dt+=n,t.status===d.Running&&(t.duration+=n),!t.gpsValid)return;const r=6371008.8+t.alt,o=t.lat*Math.PI/180,i=t.lon*Math.PI/180,s=r*Math.cos(o)*Math.cos(i),c=r*Math.cos(o)*Math.sin(i),u=r*Math.sin(o),f=t.vel;if(!t.x)return t.x=s,t.y=c,t.z=u,t.v=f,t.pError=2.5*t.dop,void(t.vError=.05*t.dop);const l=s-t.x,g=c-t.y,p=u-t.z,b=f-t.v,N=Math.sqrt(l*l+g*g+p*p),v=Math.abs(b);t.pError+=t.v*t.dt,t.dt=0;const h=N+2.5*t.dop,S=v+.05*t.dop,E=t.pError/(t.pError+h)||0,x=t.vError/(t.vError+S)||0;t.x+=l*E,t.y+=g*E,t.z+=p*E,t.v+=b*x,t.pError+=(h-t.pError)*E,t.vError+=(S-t.vError)*x,t.status===d.Running&&(t.distance+=N*E,t.speed=t.distance/t.duration||0,t.cadence=60*t.steps/t.duration||0),a(t)}(t),n(t),t.gpsValid&&t.status===d.Running&&o(t)}(c,t)),Bangle.setGPSPower(1),function(t){Bangle.on("HRM",e=>function(t,e){if(0===e.confidence)return;const n=e.bpm-t.hr,r=Math.abs(n)+101-e.confidence,i=t.hrError/(t.hrError+r)||0;t.hr+=n*i,t.hrError+=(r-t.hrError)*i,t.status===d.Running&&(o(t),a(t))}(t,e)),Bangle.setHRMPower(1)}(s),function(t){Bangle.on("step",()=>function(t){t.status===d.Running&&(t.steps+=1);a(t)}(t))}(s),function(t){Bangle.loadWidgets(),Bangle.on("lcdPower",e=>{t.drawing=e,e&&r(t)}),r(t)}(s),function(t){NRF.setServices({"f8b20001-89ad-4220-8c9f-d81756009f0c":{"f8b20002-89ad-4220-8c9f-d81756009f0c":{descriptio:"duration",notify:!0,readable:!0,value:[t.duration]},"f8b20003-89ad-4220-8c9f-d81756009f0c":{description:"distance",notify:"true",readable:"true",value:[t.distance]},"f8b20004-89ad-4220-8c9f-d81756009f0c":{description:"speed",notify:"true",readable:"true",value:[t.speed]},"f8b20005-89ad-4220-8c9f-d81756009f0c":{description:"steps",notify:"true",readable:"true",value:[t.steps]},"f8b20006-89ad-4220-8c9f-d81756009f0c":{description:"cadence",notify:"true",readable:"true",value:[t.cadence]}},"f8b20007-89ad-4220-8c9f-d81756009f0c":{"f8b20008-89ad-4220-8c9f-d81756009f0c":{description:"HR",readable:!0,notify:!0,value:[t.hr]}}})}(s),setWatch(()=>i(s),BTN1,{repeat:!0,edge:"falling"}),setWatch(()=>function(t){t.status===d.Paused&&function(t){t.duration=0,t.distance=0,t.speed=0,t.steps=0,t.cadence=0}(t),t.status===d.Running?t.status=d.Paused:t.status=d.Stopped,n(t)}(s),BTN3,{repeat:!0,edge:"falling"})}();
